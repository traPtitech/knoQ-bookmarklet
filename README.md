# knoQ-bookmarklet
東工大の教務Webシステムの施設予約ページから，traPが予約している部屋情報を抜き出すブックマークレットです．

## ブックマークレットのコード
```bookmarklet
javascript:(()=>{async function d(){let t=[];await h(),t.push(...u());for(let e=0;e<3;e++)await y(),t.push(...u());return t.filter(({timeStart:e})=>new Date().getTime()<e.getTime()).sort((e,n)=>e.timeStart.getTime()-n.timeStart.getTime())}async function h(){document.querySelector("#lblModeW").click(),document.querySelector("#tbl2 > tbody > tr:nth-child(2) > td:nth-child(1) > a").click(),await m()}async function y(){document.querySelector("#ctl00_divMainContents > div:nth-child(10) > div.hideAtPrint > table.searchTablex > tbody > tr:nth-child(1) > td:nth-child(2) > a:nth-child(6)").click(),await m()}function m(){return new Promise(t=>{let e=document.querySelector("#divTbl");new MutationObserver((o,r)=>{for(let i of o)if(i.type==="childList"&&i.addedNodes[1]?.nodeName==="DIV"){r.disconnect(),t();return}}).observe(e,{childList:!0})})}function u(){let t=document.evaluate('//span[contains(., "traP")]',document,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),e=[];for(let n=t.iterateNext();n!==null;n=t.iterateNext()){let o=n.closest("td"),r=o.closest("tr"),i=r.children[r.classList.contains("trTop")?1:0].innerText,l=o.dataset.date,[,f,b]=n.innerText.match(/(\d\d:\d\d) - (\d\d:\d\d)/);e.push({place:i,timeStart:g(l,f),timeEnd:g(l,b)})}return e}function g(t,e){let n=t.slice(0,4),o=t.slice(4,6),r=t.slice(6,8);return new Date(`${n}-${o}-${r}T${e}:00+09:00`)}function c(t,e,n){let o=new Blob([e],n),r=window.URL.createObjectURL(o),i=document.createElement("a");i.setAttribute("href",r),i.setAttribute("download",t),i.click()}function p(t){return t.length===0?"":S(()=>{let e=[...Object.keys(t[0])],n=t.map(o=>[...Object.values(o)].map(String));return[e,...n].map(o=>o.join(",")).join("\n")})}function T(t){return t.length===0?"":S(()=>{let e=[...Object.keys(t[0])],n=Array(e.length).fill("-"),o=t.map(r=>[...Object.values(r)].map(String));return[e,n,...o].map(r=>`|${r.join("|")}|`).join("\n")})}function S(t){let e=Date.prototype.toString;Date.prototype.toString=Date.prototype.toISOString;try{return t()}finally{Date.prototype.toString=e}}var s=t=>t.toLocaleDateString("ja-JP"),a=t=>t.toLocaleTimeString("ja-JP",{timeStyle:"short"});function v(t){return{\u65E5\u4ED8:s(t.timeStart),\u5834\u6240:t.place,\u958B\u59CB\u6642\u523B:a(t.timeStart),\u7D42\u4E86\u6642\u523B:a(t.timeEnd)}}function D(t){return{Subject:"\u9032\u6357\u90E8\u5C4B",Location:t.place,"Start Date":s(t.timeStart),"End Date":s(t.timeEnd),"Start Time":a(t.timeStart),"End Time":a(t.timeEnd)}}async function w(){let t=await d();if(window.confirm("\u9032\u6357\u90E8\u5C4B\u8868\u3092\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u3057\u307E\u3059\u304B?")){let e=T(t.map(v)),n=p(t.map(D));c("cal.md",e,{type:"text/markdown"}),c("cal.csv",n,{type:"text/csv"})}}w();})();
```
