# knoQ-bookmarklet
東工大の教務Webシステムの施設予約ページから，traPが予約している部屋情報を抜き出すブックマークレットです．

## ブックマークレットのコード
```bookmarklet
javascript:(()=>{async function m(){let t=[];await p(),t.push(...T());for(let e=0;e<3;e++)await w(),t.push(...T());return t.filter(({timeStart:e})=>new Date().getTime()<e.getTime()).sort((e,o)=>e.timeStart.getTime()-o.timeStart.getTime())}async function p(){document.querySelector("#lblModeW").click(),document.querySelector("#tbl2 > tbody > tr:nth-child(2) > td:nth-child(1) > a").click(),await u()}async function w(){document.querySelector("#ctl00_divMainContents > div:nth-child(10) > div.hideAtPrint > table.searchTablex > tbody > tr:nth-child(1) > td:nth-child(2) > a:nth-child(6)").click(),await u()}function u(){return new Promise(t=>{let e=document.querySelector("#divTbl");new MutationObserver((n,c)=>{for(let r of n)if(r.type==="childList"&&r.addedNodes[1]?.nodeName==="DIV"){c.disconnect(),t();return}}).observe(e,{childList:!0})})}function T(){let t=document.evaluate('//span[contains(., "traP")]',document,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),e=[];for(let o=t.iterateNext();o!==null;o=t.iterateNext()){let[,n,c]=o.innerText.match(/(\d\d:\d\d) - (\d\d:\d\d)/),r=o.closest("td"),i=r.dataset.date,a=r.closest("tr"),f=a.children[a.classList.contains("trTop")?1:0].innerText;e.push({place:f,timeStart:h(i,n),timeEnd:h(i,c)})}return e}function h(t,e){let o=t.slice(0,4),n=t.slice(4,6),c=t.slice(6,8);return new Date(`${o}-${n}-${c}T${e}:00+09:00`)}var d=t=>t.toLocaleDateString("ja-JP"),s=t=>t.toLocaleTimeString("ja-JP",{timeStyle:"short"});function S(t){let e=`|\u65E5\u4ED8|\u5834\u6240|\u958B\u59CB\u6642\u523B|\u7D42\u4E86\u6642\u523B|\n|-|-|-|-|\n`,o=t.map(n=>{let c=d(n.timeStart),r=s(n.timeStart),i=s(n.timeEnd);return`|${c}|${n.place}|${r}|${i}|`}).join(`\n`);return e+o}function b(t){let e=`Subject,Location,Start Date,End Date,Start Time,End Time\n`,o=t.map(n=>{let c=d(n.timeStart),r=d(n.timeEnd),i=s(n.timeStart),a=s(n.timeEnd);return`\u9032\u6357\u90E8\u5C4B,${n.place},${c},${r},${i},${a}`}).join(`\n`);return e+o}function l(t,e,o){let n=new Blob([e],o),c=window.URL.createObjectURL(n),r=document.createElement("a");r.setAttribute("href",c),r.setAttribute("download",t),r.click()}async function v(){let t=await m();if(window.confirm("\u9032\u6357\u90E8\u5C4B\u8868\u3092\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u3057\u307E\u3059\u304B?")){let e=S(t),o=b(t);l("cal.md",e,{type:"text/markdown"}),l("cal.csv",o,{type:"text/csv"})}}v();})();
```
