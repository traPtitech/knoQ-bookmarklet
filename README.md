# knoQ-bookmarklet
東工大の教務Webシステムの施設予約ページから，traPが予約している部屋情報を抜き出すブックマークレットです．

## ブックマークレットのコード
```bookmarklet
javascript:(()=>{async function m(){let t=[];await p(),t.push(...h());for(let e=0;e<3;e++)await w(),t.push(...h());return t.filter(({timeStart:e})=>new Date().getTime()<e.getTime()).sort((e,o)=>e.timeStart.getTime()-o.timeStart.getTime())}async function p(){document.querySelector("#lblModeW").click(),document.querySelector("#tbl2 > tbody > tr:nth-child(2) > td:nth-child(1) > a").click(),await u()}async function w(){document.querySelector("#ctl00_divMainContents > div:nth-child(10) > div.hideAtPrint > table.searchTablex > tbody > tr:nth-child(1) > td:nth-child(2) > a:nth-child(6)").click(),await u()}function u(){return new Promise(t=>{let e=document.querySelector("#divTbl");new MutationObserver((n,r)=>{for(let i of n)if(i.type==="childList"&&i.addedNodes[1]?.nodeName==="DIV"){r.disconnect(),t();return}}).observe(e,{childList:!0})})}function h(){let t=document.evaluate('//span[contains(., "traP")]',document,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),e=[];for(let o=t.iterateNext();o!==null;o=t.iterateNext()){let n=o.closest("td"),r=n.closest("tr"),i=r.children[r.classList.contains("trTop")?1:0].innerText,c=n.dataset.date,[,s,b]=o.innerText.match(/(\d\d:\d\d) - (\d\d:\d\d)/);e.push({place:i,timeStart:T(c,s),timeEnd:T(c,b)})}return e}function T(t,e){let o=t.slice(0,4),n=t.slice(4,6),r=t.slice(6,8);return new Date(`${o}-${n}-${r}T${e}:00+09:00`)}var d=t=>t.toLocaleDateString("ja-JP"),a=t=>t.toLocaleTimeString("ja-JP",{timeStyle:"short"});function f(t){if(t.length===0)return"";let e=`|\u65E5\u4ED8|\u5834\u6240|\u958B\u59CB\u6642\u523B|\u7D42\u4E86\u6642\u523B|\n|-|-|-|-|\n`,o=t.map(n=>{let r=d(n.timeStart),i=a(n.timeStart),c=a(n.timeEnd);return`|${r}|${n.place}|${i}|${c}|`}).join(`\n`);return e+o}function S(t){if(t.length===0)return"";let e=`Subject,Location,Start Date,End Date, Start Time, End Time\n`,o=t.map(n=>{let r=d(n.timeStart),i=d(n.timeEnd),c=a(n.timeStart),s=a(n.timeEnd);return`\u9032\u6357\u90E8\u5C4B,${n.place},${r},${i},${c},${s}`}).join(`\n`);return e+o}function l(t,e,o){let n=new Blob([e],o),r=window.URL.createObjectURL(n),i=document.createElement("a");i.setAttribute("href",r),i.setAttribute("download",t),i.click()}async function v(){let t=await m();if(window.confirm("\u9032\u6357\u90E8\u5C4B\u8868\u3092\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u3057\u307E\u3059\u304B?")){let e=f(t),o=S(t);l("cal.md",e,{type:"text/markdown"}),l("cal.csv",o,{type:"text/csv"})}}v();})();
```
