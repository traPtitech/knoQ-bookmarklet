# knoQ-bookmarklet
東工大の教務Webシステムの施設予約ページから，traPが予約している部屋情報を抜き出すブックマークレットです．

## ブックマークレットのコード
```bookmarklet
javascript:(()=>{async function m(){let t=[];await g(),t.push(...h());for(let e=0;e<3;e++)await p(),t.push(...h());return t.filter(({timeStart:e})=>new Date().getTime()<e.getTime()).sort((e,o)=>e.timeStart.getTime()-o.timeStart.getTime())}async function g(){document.querySelector("#lblModeW").click(),document.querySelector("#tbl2 > tbody > tr:nth-child(2) > td:nth-child(1) > a").click(),await u()}async function p(){document.querySelector("#ctl00_divMainContents > div:nth-child(10) > div.hideAtPrint > table.searchTablex > tbody > tr:nth-child(1) > td:nth-child(2) > a:nth-child(6)").click(),await u()}function u(){return new Promise(t=>{let e=document.querySelector("#divTbl");new MutationObserver((n,r)=>{for(let i of n)if(i.type==="childList"&&i.addedNodes[1]?.nodeName==="DIV"){r.disconnect(),t();return}}).observe(e,{childList:!0})})}function h(){let t=document.evaluate('//span[contains(., "traP")]',document,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),e=[];for(let o=t.iterateNext();o!==null;o=t.iterateNext()){let[,n,r]=o.innerText.match(/(\d\d:\d\d) - (\d\d:\d\d)/),i=o.closest("td"),c=i.dataset.date,a=i.closest("tr"),S=a.children[a.classList.contains("trTop")?1:0].innerText;e.push({place:S,timeStart:T(c,n),timeEnd:T(c,r)})}return e}function T(t,e){let o=t.slice(0,4),n=t.slice(4,6),r=t.slice(6,8);return new Date(`${o}-${n}-${r}T${e}:00+09:00`)}var d=t=>t.toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"}),s=t=>t.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"});function b(t){let e=`|\u65E5\u4ED8|\u5834\u6240|\u958B\u59CB\u6642\u523B|\u7D42\u4E86\u6642\u523B|\n|-|-|-|-|\n`,o=t.map(n=>{let r=d(n.timeStart),i=s(n.timeStart),c=s(n.timeEnd);return`|${r}|${n.place}|${i}|${c}|`}).join(`\n`);return e+o}function f(t){let e=`Subject,Location,Start date,End date,Start time,End time\n`,o=t.map(n=>{let r=d(n.timeStart),i=d(n.timeEnd),c=s(n.timeStart),a=s(n.timeEnd);return`\u9032\u6357\u90E8\u5C4B,${n.place},${r},${i},${c},${a}`}).join(`\n`);return e+o}function l(t,e,o){let n=new Blob([e],o),r=window.URL.createObjectURL(n),i=document.createElement("a");i.setAttribute("href",r),i.setAttribute("download",t),i.click()}async function w(){let t=await m();if(window.confirm("\u9032\u6357\u90E8\u5C4B\u8868\u3092\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u3057\u307E\u3059\u304B?")){let e=b(t),o=f(t);l("cal.md",e,{type:"text/markdown"}),l("cal.csv",o,{type:"text/csv"})}}w();})();
```
